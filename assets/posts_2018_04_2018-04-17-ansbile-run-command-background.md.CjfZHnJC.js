import{_ as s,a as i,o as a,aj as n}from"./chunks/framework.Ba_Ek9Jm.js";const m=JSON.parse('{"title":"Run Ansible Task Background (Daemon Mode)","description":"","frontmatter":{"title":"Run Ansible Task Background (Daemon Mode)","date":"2018-04-17T00:00:00.000Z","tags":["ansible"]},"headers":[],"relativePath":"posts/2018/04/2018-04-17-ansbile-run-command-background.md","filePath":"posts/2018/04/2018-04-17-ansbile-run-command-background.md","lastUpdated":1718173059000}'),e={name:"posts/2018/04/2018-04-17-ansbile-run-command-background.md"},t=n(`<p>有尝试过用<code>shell</code>执行<code>nohup</code>命令，测试了几种方式都失败，比如：</p><ul><li>平时\b的运行方式<div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Start daemon</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  shell</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">nohup myexeprogram arg1 arg2 &amp;</span></span></code></pre></div></li><li>Stackoverflow上: <a href="https://stackoverflow.com/questions/39347379/ansible-run-command-on-remote-host-in-background" target="_blank" rel="noreferrer">ansible run command on remote host in background</a><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">hosts</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">centos-target</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  gather_facts</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">no</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  tasks</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">shell</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;(cd /; python -mSimpleHTTPServer &gt;/dev/null 2&gt;&amp;1 &amp;)&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      async</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">10</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      poll</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0</span></span></code></pre></div><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">start simple http server in background</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  shell</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cd /tmp/www; nohup python -mSimpleHTTPServer &lt;/dev/null &gt;/dev/null 2&gt;&amp;1 &amp;</span></span></code></pre></div></li></ul><p>最终找到解释，使用<code>&amp;</code>执行程序并不会让程序成为deamon，只是后台运行，包括nohup一样。</p><ul><li><p>如果程序是C程序，可以调用<code>daemon()</code>方法。</p></li><li><p>其他程序可以使用 <a href="http://libslack.org/daemon/manpages/daemon.1.html" target="_blank" rel="noreferrer">daemon</a> 程序来实现</p><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">Start daemon</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  shell</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">daemon -- myexeprogram arg1 arg2</span></span></code></pre></div></li></ul><p><a href="https://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/html/deployment-install.html#deployment-service" target="_blank" rel="noreferrer">Springboot作为服务运行</a>中的方案，测试后启动失败，可能还差了什么吧。</p><h3 id="as-init-d-service" tabindex="-1">As init.d service <a class="header-anchor" href="#as-init-d-service" aria-label="Permalink to &quot;As init.d service&quot;">​</a></h3><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> link</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /var/myapp/myapp.jar</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /etc/init.d/myapp</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># or</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ln</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ~/myproject/build/libs/myapp-1.0.jar</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /etc/init.d/myapp_servicename</span></span></code></pre></div><p>then:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">/etc/init.d/myapp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> start</span></span></code></pre></div><h3 id="as-a-systemd-service" tabindex="-1">As a systemd service <a class="header-anchor" href="#as-a-systemd-service" aria-label="Permalink to &quot;As a systemd service&quot;">​</a></h3><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">[Unit]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">Description</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">=myapp</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">After</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">=syslog.target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">[Service]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">ExecStart</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">=/var/myapp/myapp.jar</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">[Install]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">WantedBy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">=multi-user.target</span></span></code></pre></div><hr><p>Links:</p><ul><li><a href="https://stackoverflow.com/questions/29806673/daemonizing-an-executable-in-ansible" target="_blank" rel="noreferrer">Daemonizing an executable in ansible</a></li></ul>`,14),l=[t];function p(h,k,d,r,o,c){return a(),i("div",null,l)}const y=s(e,[["render",p]]);export{m as __pageData,y as default};
