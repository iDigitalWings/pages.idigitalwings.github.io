import{_ as i,a,af as e,o as t}from"./chunks/framework.C87LdZyP.js";const c=JSON.parse('{"title":"AWS CLI and RedShift","description":"","frontmatter":{"title":"AWS CLI and RedShift","date":"2019-09-30T00:00:00.000Z","tags":["aws","redshift"],"category":["Tools"]},"headers":[],"relativePath":"posts/2019/09/2019-09-30-aws-redshift.md","filePath":"posts/2019/09/2019-09-30-aws-redshift.md","lastUpdated":1718173059000}'),n={name:"posts/2019/09/2019-09-30-aws-redshift.md"};function l(h,s,p,r,k,d){return t(),a("div",null,s[0]||(s[0]=[e(`<p>AWS 使用的第一个服务 RedShift。从安装命令行开始，到数据连接测试。中间拷贝数据遇到了点问题， 最后自己上传了一份样例数据到 S3 上进行了测试。</p><h2 id="cli-工具" tabindex="-1">CLI 工具 <a class="header-anchor" href="#cli-工具" aria-label="Permalink to &quot;CLI 工具&quot;">​</a></h2><ul><li><a href="https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/cli-chap-install.html" target="_blank" rel="noreferrer">安装 AWS CLI</a></li></ul><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> awscli</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --upgrade</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --user</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> PATH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">/Users/alan/.local/bin:$PATH</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">aws</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --version</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> list</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -o</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --upgrade</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --user</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> awscli</span></span></code></pre></div><ul><li><a href="https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/getting-started_create-admin-group.html" target="_blank" rel="noreferrer">IAM 用户和组</a></li></ul><p>可以根据文档创建一个完整权限的编程用户。</p><ul><li><p><a href="https://docs.aws.amazon.com/zh_cn/redshift/latest/mgmt/setting-up-rs-cli.html" target="_blank" rel="noreferrer">设置CLI</a></p></li><li><p><a href="https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/cli-chap-configure.html" target="_blank" rel="noreferrer">https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/cli-chap-configure.html</a></p></li></ul><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">base</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">➜</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  ~</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> aws</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> configure</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">AWS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Access</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Key</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ID</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> [None]: xx</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">AWS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Secret</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Access</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Key</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> [None]: K/xxx</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> region</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> [None]: cn-northwest-1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> output</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> format</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> [None]: json</span></span></code></pre></div><p>格式只有 <code>json</code>，<code>text</code>， <code>table</code> 三种， 要是有 yaml 格式i就好了。</p><p>如果要创建多个配置：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">aws</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> configure</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --profile</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> produser</span></span></code></pre></div><p>运行命令的时候可以指定 profile：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">aws</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> s3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --profile</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> produser</span></span></code></pre></div><h2 id="access" tabindex="-1">Access <a class="header-anchor" href="#access" aria-label="Permalink to &quot;Access&quot;">​</a></h2><p>设置权限</p><ul><li><a href="https://docs.amazonaws.cn/en_us/redshift/latest/gsg/rs-gsg-authorize-cluster-access.html" target="_blank" rel="noreferrer">https://docs.amazonaws.cn/en_us/redshift/latest/gsg/rs-gsg-authorize-cluster-access.html</a></li></ul><p>然后就可以通过客户端工具连接了。</p><h2 id="加载数据" tabindex="-1">加载数据 <a class="header-anchor" href="#加载数据" aria-label="Permalink to &quot;加载数据&quot;">​</a></h2><ul><li><a href="https://docs.aws.amazon.com/zh_cn/redshift/latest/gsg/rs-gsg-create-sample-db.html" target="_blank" rel="noreferrer">https://docs.aws.amazon.com/zh_cn/redshift/latest/gsg/rs-gsg-create-sample-db.html</a></li></ul><p>执行</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">sql&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> copy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;s3://awssampledbuswest2/tickit/allusers_pipe.txt&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">     credentials </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;aws_iam_role=arn:aws-cn:iam::xxx:role/myRedshiftRole&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">     delimiter </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;|&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> region </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;cn-northwest-1&#39;</span></span></code></pre></div><p>错误</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span>[2019-09-30 15:30:45] [XX000][500310] [Amazon](500310) Invalid operation: User arn:aws-cn:redshift:cn-northwest-1:xxx:dbuser:xxx/xxx is not authorized to assume IAM Role arn:aws-cn:iam::xxx:role/myRedshiftRole</span></span></code></pre></div><p>解决</p><p>打开 cluster 设置，<code>IAM Roles</code> 应用一下权限即可。</p><p>再次执行</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span>[XX000][500310] [Amazon](500310) Invalid operation: S3ServiceException:The specified bucket does not exist,Status 404,Error NoSuchBucket,Rid</span></span></code></pre></div><p>再次执行</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">copy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;s3://awssampledbuswest2/tickit/allusers_pipe.txt&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">credentials </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;aws_iam_role=arn:aws-cn:iam::xxx:role/myRedshiftRole&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">delimiter </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;|&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> region </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;us-west-2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span>S3ServiceException:The provided token is malformed or otherwise invalid</span></span></code></pre></div><p><a href="https://docs.aws.amazon.com/zh_cn/redshift/latest/dg/s3serviceexception-error.html" target="_blank" rel="noreferrer">https://docs.aws.amazon.com/zh_cn/redshift/latest/dg/s3serviceexception-error.html</a></p><p>可能是集群和 s3 不在一个区域。</p><ul><li><a href="https://stackoverflow.com/questions/24860468/amazon-redshift-copy-command" target="_blank" rel="noreferrer">https://stackoverflow.com/questions/24860468/amazon-redshift-copy-command</a></li></ul><p>更改成宁夏区域：</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">copy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;s3://awssampledbcnnorthwest1/tickit/allusers_pipe.txt&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    credentials </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;aws_iam_role=arn:aws-cn:iam::xxx:role/myRedshiftRole&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    delimiter </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;|&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> region </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;cn-northwest-1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span></code></pre></div><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">[XX000][500310] [Amazon](</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">500310</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) Invalid operation: S3ServiceException:Access Denied,Status 403,Error AccessDenied</span></span></code></pre></div><p>柠檬了个鬼。</p><p><a href="https://s3.cn-northwest-1.amazonaws.com.cn/cybertrans/Book1.csv" target="_blank" rel="noreferrer">https://s3.cn-northwest-1.amazonaws.com.cn/cybertrans/Book1.csv</a></p><p>自己写了个数据放到 s3 上测试</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">copy</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;s3://cybertrans/users.csv&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    credentials </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;aws_iam_role=arn:aws-cn:iam::xxx:role/myRedshiftRole&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    delimiter </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;,&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> region </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;cn-northwest-1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span></code></pre></div><p>OK。</p><p>文档中有复制权限到其他 region 的描述，没有测试。</p><ul><li><a href="https://docs.aws.amazon.com/zh_cn/redshift/latest/mgmt/authorizing-redshift-service.html" target="_blank" rel="noreferrer">https://docs.aws.amazon.com/zh_cn/redshift/latest/mgmt/authorizing-redshift-service.html</a></li></ul><p>先用测试数据进行了基本的查询，仅作测试用。由于数据量比较小也提现不出来性能什么的。今天先到这里。</p><h2 id="表设计" tabindex="-1">表设计 <a class="header-anchor" href="#表设计" aria-label="Permalink to &quot;表设计&quot;">​</a></h2><p><a href="https://docs.aws.amazon.com/zh_cn/redshift/latest/dg/tutorial-tuning-tables-create-test-data.html" target="_blank" rel="noreferrer">https://docs.aws.amazon.com/zh_cn/redshift/latest/dg/tutorial-tuning-tables-create-test-data.html</a></p><hr>`,47)]))}const g=i(n,[["render",l]]);export{c as __pageData,g as default};
