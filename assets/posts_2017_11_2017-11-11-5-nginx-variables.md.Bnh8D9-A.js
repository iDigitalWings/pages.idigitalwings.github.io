import{_ as a,a as i,af as n,o as p}from"./chunks/framework.C87LdZyP.js";const c=JSON.parse('{"title":"Nginx: Variable Usage","description":"","frontmatter":{"title":"Nginx: Variable Usage","date":"2017-11-11T00:00:00.000Z","tags":["nginx"]},"headers":[],"relativePath":"posts/2017/11/2017-11-11-5-nginx-variables.md","filePath":"posts/2017/11/2017-11-11-5-nginx-variables.md","lastUpdated":1718175555000}'),l={name:"posts/2017/11/2017-11-11-5-nginx-variables.md"};function e(t,s,h,k,d,o){return p(),i("div",null,s[0]||(s[0]=[n(`<p>Nginx的配置文件也算是一门编程语言，设计上受 Perl 和 Bourne shell 的影响。</p><p>这种“语言”的变量只有一种类型，那就是字符串，设置变量如下：</p><div class="language-perl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">perl</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">set $a </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;hello world&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span></code></pre></div><p><code>set</code>指令是标准模块 <code>ngx_rewrite</code> 提供的。</p><p>语法要求变量名字都以<code>$</code>开头。</p><p>类似Perl的variable interpolation。</p><div class="language-perl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">perl</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">set $a hello;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">set $b </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">, </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># $b: hello hello</span></span></code></pre></div><p>比如配置一个简单的server：</p><div class="language-perl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">perl</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">server {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  listen</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> 8080;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  location /test {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    set $foo hello;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    echo </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;foo: </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$foo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p><code>echo</code>指令是第三方模块<code>ngx_echo</code>提供的。</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> curl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;http://127.0.0.1:8080/test&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">foo:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> hello</span></span></code></pre></div><p>字符串中使用<code>$</code>,</p><div class="language-perl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">perl</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">geo $dollar {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  default</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">server {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  listen 8080;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  location /test {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">    echo &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">This is a dollar sign: $dollar</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  }</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}</span></span></code></pre></div><p>测试：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span>$ curl &#39;http://127.0.0.1:8080/test&#39;</span></span>
<span class="line"><span>This is a dollar sign: $</span></span></code></pre></div><p><code>geo</code>指令由标准模块<code>ngx_geo</code>提供。</p><h3 id="格式来消除歧义" tabindex="-1"><code>\${}</code> 格式来消除歧义 <a class="header-anchor" href="#格式来消除歧义" aria-label="Permalink to &quot;\`\${}\` 格式来消除歧义&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span>server {</span></span>
<span class="line"><span>  listen 8080;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  location /test {</span></span>
<span class="line"><span>    set $first &quot;hello &quot;;</span></span>
<span class="line"><span>    echo &quot;\${first}world&quot;;</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="set和geo由创建变量的功能-如果变量未定义就使用会报错" tabindex="-1"><code>set</code>和<code>geo</code>由创建变量的功能，如果变量未定义就使用会报错: <a class="header-anchor" href="#set和geo由创建变量的功能-如果变量未定义就使用会报错" aria-label="Permalink to &quot;\`set\`和\`geo\`由创建变量的功能，如果变量未定义就使用会报错:&quot;">​</a></h3><div class="language-perl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">perl</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> server {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  listen</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> 8080;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  location /bad {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    echo $foo;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> }</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span>[emerg] unknown &quot;foo&quot; variable</span></span></code></pre></div><h2 id="变量的作用范围" tabindex="-1">变量的作用范围 <a class="header-anchor" href="#变量的作用范围" aria-label="Permalink to &quot;变量的作用范围&quot;">​</a></h2><ul><li>定义后这个配置可见</li><li>每个请求都有独立的变量副本 <ul><li>Nginx 变量的生命期是不可能跨越请求边界</li></ul></li></ul><div class="language-perl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">perl</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">server {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  listen</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> 8080;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  location /foo {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    echo </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;foo = [</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$foo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">]&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  location /bar {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    set $foo 32;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    echo </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;foo = [</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$foo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">]&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> curl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;http://127.0.0.1:8080/foo&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">foo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> []</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> curl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;http://127.0.0.1:8080/bar&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">foo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> [32]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> curl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;http://127.0.0.1:8080/foo&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">foo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> []</span></span></code></pre></div><h3 id="内部跳转" tabindex="-1">内部跳转 <a class="header-anchor" href="#内部跳转" aria-label="Permalink to &quot;内部跳转&quot;">​</a></h3><p><code>echo_exec</code> 由第三方模块 <code>ngx_echo</code> 提供</p><div class="language-perl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">perl</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">server {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  listen</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> 8080;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  location /foo {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    set $a hello;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    echo_exec /bar;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  location /bar {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    echo </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;a = [</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">]&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span>$ curl localhost:8080/foo</span></span>
<span class="line"><span>a = [hello]</span></span></code></pre></div><p>标准 <code>ngx_rewrite</code> 模块的 <code>rewrite</code> 配置指令也可以发起“内部跳转”</p><div class="language-perl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">perl</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">server {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  listen</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> 8080;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  location /foo {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    set $a hello;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    rewrite ^ /bar;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  location /bar {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    echo </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;a = [</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$a</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">]&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><h2 id="内建变量" tabindex="-1">内建变量 <a class="header-anchor" href="#内建变量" aria-label="Permalink to &quot;内建变量&quot;">​</a></h2><p>最常见的用途就是获取关于请求或响应的各种信息</p><h3 id="ngx-http-core-模块提供的内建变量-uri" tabindex="-1">ngx_http_core 模块提供的内建变量 $uri <a class="header-anchor" href="#ngx-http-core-模块提供的内建变量-uri" aria-label="Permalink to &quot;ngx_http_core 模块提供的内建变量 $uri&quot;">​</a></h3><p>$uri，可以用来获取当前请求的 URI（经过解码，并且不含请求参数）， 而 $request_uri 则用来获取请求最原始的 URI （未经解码，并且包含请求参数）</p><div class="language-perl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">perl</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">location /test {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  echo </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;uri = </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$uri</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  echo </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;request_uri = </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$request_uri</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span>$ curl &#39;http://127.0.0.1:8080/test&#39;</span></span>
<span class="line"><span>uri = /test</span></span>
<span class="line"><span>request_uri = /test</span></span>
<span class="line"><span>$ curl &#39;http://127.0.0.1:8080/test?a=3&amp;b=4&#39;</span></span>
<span class="line"><span>uri = /test</span></span>
<span class="line"><span>request_uri = /test?a=3&amp;b=4</span></span>
<span class="line"><span>$ curl &#39;http://127.0.0.1:8080/test/hello%20world?a=3&amp;b=4&#39;</span></span>
<span class="line"><span>uri = /test/hello world</span></span>
<span class="line"><span>request_uri = /test/hello%20world?a=3&amp;b=4</span></span></code></pre></div><h2 id="arg-xxx-变量" tabindex="-1"><code>$arg_XXX</code> 变量 <a class="header-anchor" href="#arg-xxx-变量" aria-label="Permalink to &quot;\`$arg_XXX\` 变量&quot;">​</a></h2><div class="language-perl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">perl</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">location /test {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  echo </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;name: </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$arg_name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  echo </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;class: </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$arg_class</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span>$ curl &#39;http://127.0.0.1:8080/test&#39;</span></span>
<span class="line"><span>name:</span></span>
<span class="line"><span>class:</span></span>
<span class="line"><span>$ curl &#39;http://127.0.0.1:8080/test?name=Tom&amp;class=3&#39;</span></span>
<span class="line"><span>name: Tom</span></span>
<span class="line"><span>class: 3</span></span>
<span class="line"><span>$ curl &#39;http://127.0.0.1:8080/test?name=hello%20world&amp;class=9&#39;</span></span>
<span class="line"><span>name: hello%20world</span></span>
<span class="line"><span>class: 9</span></span></code></pre></div><h3 id="base64-解码" tabindex="-1">Base64 解码 <a class="header-anchor" href="#base64-解码" aria-label="Permalink to &quot;Base64 解码&quot;">​</a></h3><p>ngx_set_misc 模块提供的 set_unescape_uri</p><div class="language-perl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">perl</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">location /test {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  set_unescape_uri $name $arg_name;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  set_unescape_uri $class $arg_class;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  echo </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;name: </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  echo </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;class: </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$class</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span>$ curl &#39;http://127.0.0.1:8080/test?name=hello%20world&amp;class=9&#39;</span></span>
<span class="line"><span>name: hello world</span></span>
<span class="line"><span>class: 9</span></span></code></pre></div><p>看到空格被解码出来了。</p><h3 id="取cookie值的-cookie-xxx" tabindex="-1">取cookie值的 <code>$cookie_XXX</code> <a class="header-anchor" href="#取cookie值的-cookie-xxx" aria-label="Permalink to &quot;取cookie值的 \`$cookie_XXX\`&quot;">​</a></h3><h3 id="取请求头的-http-xxx" tabindex="-1">取请求头的 <code>$http_XXX</code> <a class="header-anchor" href="#取请求头的-http-xxx" aria-label="Permalink to &quot;取请求头的 \`$http_XXX\`&quot;">​</a></h3><h3 id="取响应头的-sent-http-xxx" tabindex="-1">取响应头的 <code>$sent_http_XXX</code> <a class="header-anchor" href="#取响应头的-sent-http-xxx" aria-label="Permalink to &quot;取响应头的 \`$sent_http_XXX\`&quot;">​</a></h3><h2 id="args-改写-影响-arg-xxx" tabindex="-1"><code>$args</code> 改写，影响 <code>$arg_XXX</code> <a class="header-anchor" href="#args-改写-影响-arg-xxx" aria-label="Permalink to &quot;\`$args\` 改写，影响 \`$arg_XXX\`&quot;">​</a></h2><div class="language-perl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">perl</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">location /test {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  set $orig_args $args;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  set $args </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;a=3&amp;b=4&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  echo </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;original args: </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$orig_args</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  echo </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;args: </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$args</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span>$ curl &#39;http://127.0.0.1:8080/test&#39;</span></span>
<span class="line"><span>original args:</span></span>
<span class="line"><span>args: a=3&amp;b=4</span></span>
<span class="line"><span>$ curl &#39;http://127.0.0.1:8080/test?a=0&amp;b=1&amp;c=2&#39;</span></span>
<span class="line"><span>original args: a=0&amp;b=1&amp;c=2</span></span>
<span class="line"><span>args: a=3&amp;b=4</span></span></code></pre></div><p>通过修改 $args 变量影响标准的 HTTP 代理模块 ngx_proxy 的例子:</p><div class="language-perl vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">perl</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">server {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  listen</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> 8080;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  location /test {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    set $args </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;foo=1&amp;bar=2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    proxy_pass http://127.0.0.1:8081/args;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">server {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  listen</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> 8081;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  location /args {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    echo </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;args: </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$args</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span>$ curl &#39;http://127.0.0.1:8080/test?blah=7&#39;</span></span>
<span class="line"><span>args: foo=1&amp;bar=2</span></span></code></pre></div>`,54)]))}const g=a(l,[["render",e]]);export{c as __pageData,g as default};
