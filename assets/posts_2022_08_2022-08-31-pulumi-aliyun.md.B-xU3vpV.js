import{_ as i,a,af as n,o as l}from"./chunks/framework.C87LdZyP.js";const h="/assets/pulumi-new.STUKSZA_.png",c=JSON.parse('{"title":"使用 Pulumi 创建阿里云 RDS 数据库","description":"","frontmatter":{"title":"使用 Pulumi 创建阿里云 RDS 数据库","date":"2022-08-31T00:00:00.000Z","tags":["pulumi","aliyun"],"category":["其它"]},"headers":[],"relativePath":"posts/2022/08/2022-08-31-pulumi-aliyun.md","filePath":"posts/2022/08/2022-08-31-pulumi-aliyun.md","lastUpdated":1718173059000}'),p={name:"posts/2022/08/2022-08-31-pulumi-aliyun.md"};function t(k,s,e,d,r,g){return l(),a("div",null,s[0]||(s[0]=[n(`<h2 id="安装" tabindex="-1">安装 <a class="header-anchor" href="#安装" aria-label="Permalink to &quot;安装&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -fsSL</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> https://get.pulumi.com</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> sh</span></span></code></pre></div><p>然后加入环境变量：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> PATH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$PATH:$HOME/.pulumi/bin</span></span></code></pre></div><p>也可以直接下载 二进制包，并加入 PATH：</p><p><a href="https://get.pulumi.com/releases/sdk/pulumi-v3.46.1-darwin-arm64.tar.gz" target="_blank" rel="noreferrer">pulumi arm64 v3.46.1 </a></p><p>测试安装是否成功：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> pulumi version</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">v3.46.0</span></span></code></pre></div><h2 id="阿里云配置" tabindex="-1">阿里云配置 <a class="header-anchor" href="#阿里云配置" aria-label="Permalink to &quot;阿里云配置&quot;">​</a></h2><ol><li><p><strong>可以通过阿里云主账号来使用Pulumi，但为提高权限管理的灵活性和安全性，建议您创建RAM用户，并为其授权。</strong></p><ol><li>登录 <a href="https://ram.console.aliyun.com/#/overview" target="_blank" rel="noreferrer">RAM控制台</a>。</li><li>创建名为<strong>Pulumi</strong>的RAM用户，并为该用户创建AccessKey。具体步骤参见 <a href="https://www.alibabacloud.com/help/en/resource-access-management/latest/basic-operations-create-a-ram-user" target="_blank" rel="noreferrer">创建RAM用户</a></li><li>为RAM用户授权。</li></ol></li><li><p><strong>设置阿里云身份认证信息</strong> 打开<a href="https://usercenter.console.aliyun.com/#/manage/ak" target="_blank" rel="noreferrer">阿里云用户信息管理控制台</a>， 查询AccessKeyID和AccessKeySecret。然后设置环境变量，如下：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> ALICLOUD_ACCESS_KEY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">xxxxxx</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> ALICLOUD_SECRET_KEY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">xxxxxx</span></span></code></pre></div></li></ol><h2 id="pulumi-配置" tabindex="-1">Pulumi 配置 <a class="header-anchor" href="#pulumi-配置" aria-label="Permalink to &quot;Pulumi 配置&quot;">​</a></h2><ol><li><p><strong>前往</strong> <a href="https://www.pulumi.com/docs/get-started/install/" target="_blank" rel="noreferrer">Pulumi官网</a>注册 Pulumi的账号</p></li><li><p><strong>创建Pulumi的access token</strong> 登录 <a href="https://app.pulumi.com/" target="_blank" rel="noreferrer">Pulumi控制台</a>，单击用户头像，选择“Settings”。进入设置页（如下图所示），单击“Access Tokens” 菜单，单击“New ACCESS TOKEN” 按钮进行创建。</p></li><li><p>创建完成后，页面会展示生成的token，把它复制下来，access token 仅展示一次。</p></li><li><p><strong>设置Pulumi accesstoken 环境变量</strong></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> PULUMI_ACCESS_TOKEN</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">pul-37</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">****</span></span></code></pre></div></li></ol><h2 id="创建应用" tabindex="-1">创建应用 <a class="header-anchor" href="#创建应用" aria-label="Permalink to &quot;创建应用&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">pulumi</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --dir</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> aliyun</span></span></code></pre></div><p>然后选择 <code>alibaba-typescript</code> 模板。</p><p><img src="`+h+`" alt=""></p><h2 id="创建-stack" tabindex="-1">创建 Stack <a class="header-anchor" href="#创建-stack" aria-label="Permalink to &quot;创建 Stack&quot;">​</a></h2><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">pulumi</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> stack</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> init</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> somestack</span></span></code></pre></div><p>设置环境变量：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">pulumi</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> config</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> set</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> saas.rdsId=rm-xxx</span></span></code></pre></div><p>生成 文件 <code>Pulumi.somestack.yaml</code>：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">config</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">   alicloud:region</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">cn-beijing</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">   aliyun:sass</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">      rdsId</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">rm-xxx</span></span></code></pre></div><p>修改 <code>index.ts</code>，给指定 rds 创建不同环境的不同数据库：</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> pulumi </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;@pulumi/pulumi&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">import</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> alicloud </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;@pulumi/alicloud&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> SaaS</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">  rdsId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">  passwords</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> { [</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">index</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> tenant</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> pulumi.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">getStack</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> config</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> pulumi.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">Config</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> saas</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> config.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">requireObject</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">SaaS</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">&gt;(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;sass&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> rdsId</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> saas.rdsId;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> dbs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;app1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;app2&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;app3&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> accountName</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> \`saas_\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">tenant</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}\`</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> account</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> alicloud.rds.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">RdsAccount</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(accountName, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  dbInstanceId: saas.rdsId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  accountName: accountName,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  accountPassword:  </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  accountDescription: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">\`「\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">tenant</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}」租户\`</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">});</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> databases</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> dbs</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">db</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> \`saas-\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">tenant</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}-\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">db</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">dbName</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    new</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> alicloud.rds.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">Database</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(dbName,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">      {instanceId: rdsId, name: dbName},</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">      // {import: \`\${rdsId}:\${dbName}\`}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> privilege</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> alicloud.rds.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">AccountPrivilege</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">\`\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">accountName</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}-privilege\`</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  instanceId: rdsId,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  accountName: account.accountName,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  privilege: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;ReadWrite&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  dbNames: databases.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#F69D50;">db</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> db.name),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">});</span></span></code></pre></div><p>预览：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> pulumi preview</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Previewing</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> update</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (somestack)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">View</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> Live:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> https://app.pulumi.com/...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">     Type</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                              Name</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                       Plan</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">     pulumi:pulumi:Stack</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">               saas-prod-somestack</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">              running</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> +</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   ├─</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> alicloud:rds:Database</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          saas-somestack-app2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">              create</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> +</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   ├─</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> alicloud:rds:Database</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          saas-somestack-app3</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">              create</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> +</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   ├─</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> alicloud:rds:Database</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">          saas-somestack-app1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">              create</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> +</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   ├─</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> alicloud:rds:AccountPrivilege</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">  saas_somestack-privilege</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">         create</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> +</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">   └─</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> alicloud:rds:RdsAccount</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">        saas_somestack</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">                   create</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Resources:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    +</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> create</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    5</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> changes.</span></span></code></pre></div><p>可以检查相关资源是否正确。</p><p>执行：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">pulumi</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> up</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -y</span></span></code></pre></div><h2 id="ci-cd" tabindex="-1">CI CD <a class="header-anchor" href="#ci-cd" aria-label="Permalink to &quot;CI CD&quot;">​</a></h2><p>提前在 Gitlab 上配置好环境变量。</p><p>使用 shell-runner，或者 docker-runner。<a href="https://hub.docker.com/r/pulumi/pulumi-nodejs" target="_blank" rel="noreferrer">Docker 镜像</a>：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">pulumi/pulumi-nodejs</span></span></code></pre></div><p><code>.gitlab-ci.yml</code></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">stages</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">  - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">infrastructure-update</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">pulumi</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  stage</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">infrastructure-update</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  tags</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">shell</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  before_script</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">pulumi login</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  script</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">bash deploy.sh</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">  only</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">main</span></span></code></pre></div><p><code>deploy.sh</code></p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;COMMIT_SHA: </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$CI_COMMIT_SHA</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">CHANGED_FILES</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> diff-tree</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --no-commit-id</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --name-only</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -r</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$CI_COMMIT_SHA</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;CHANGED_FILES: </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$CHANGED_FILES</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#cd xxx || exit</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">yarn</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> install</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> FILE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $CHANGED_FILES</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">do</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> [[ $FILE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=~</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (Pulumi</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">\\.</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)([^</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">\\w</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;">\\.</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">yaml) ]]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">then</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    STACK</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">\${BASH_REMATCH[2]}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    pulumi</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> stack</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> init</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;\${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">STACK</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">}&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> ||</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> echo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;Stack \${</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">STACK</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">} already exists&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">    echo</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;Deploy pulumin stack: </span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$STACK</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    pulumi</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> stack</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> select</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$STACK</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    pulumi</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> up</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -y</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">  fi</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">done</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">#cd - || exit</span></span></code></pre></div><hr><ul><li><a href="https://www.pulumi.com/docs/get-started/install/" target="_blank" rel="noreferrer">Pulumi 安装</a></li></ul>`,39)]))}const y=i(p,[["render",t]]);export{c as __pageData,y as default};
