import{_ as i,a,af as n,o as l}from"./chunks/framework.C87LdZyP.js";const o=JSON.parse('{"title":"MySql: innodb_lock_wait","description":"","frontmatter":{"title":"MySql: innodb_lock_wait","date":"2017-07-24T00:00:00.000Z","tags":["mysql","lock"]},"headers":[],"relativePath":"posts/2017/07/2017-07-24-mysql-lock-wait.md","filePath":"posts/2017/07/2017-07-24-mysql-lock-wait.md","lastUpdated":1718193786000}'),t={name:"posts/2017/07/2017-07-24-mysql-lock-wait.md"};function p(e,s,h,k,d,r){return l(),a("div",null,s[0]||(s[0]=[n(`<p>常见错误:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span>Lock wait timeout exceeded</span></span></code></pre></div><p>一个事务长时间执行,或者执行完未提交.其他事务在抢占资源的时候,就会因上一个事务的锁 而导致抢占失败,出现<code>Lock wait timeout exceeded</code>.</p><p>解决:</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">show processlist;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">show full processlist;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">show engine innodb </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> FROM</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> INFORMATION_SCHEMA</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">INNODB_LOCKS</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">kill</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">lock_trx_id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span></code></pre></div><p>Lock相关表:</p><div class="language-markdown vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">markdown</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">innodb_trx         # 当前运行的所有事务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">innodb_locks       # 当前出现的锁</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">innodb_lock_waits  # 锁等待的对应关系</span></span></code></pre></div><div class="language-markdown vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">markdown</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">&gt; desc innodb_locks;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">+————-+———————+——+—–+———+——-+</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| Field       | Type                | Null | Key | Default | Extra |</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">+————-+———————+——+—–+———+——-+</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| lock_id     | varchar(81)         | NO   |     |         |       |#锁ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| lock_trx_id | varchar(18)         | NO   |     |         |       |#拥有锁的事务ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| lock_mode   | varchar(32)         | NO   |     |         |       |#锁模式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| lock_type   | varchar(32)         | NO   |     |         |       |#锁类型</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| lock_table  | varchar(1024)       | NO   |     |         |       |#被锁的表</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| lock_index  | varchar(1024)       | YES  |     | NULL    |       |#被锁的索引</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| lock_space  | bigint(21) unsigned | YES  |     | NULL    |       |#被锁的表空间号</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| lock_page   | bigint(21) unsigned | YES  |     | NULL    |       |#被锁的页号</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| lock_rec    | bigint(21) unsigned | YES  |     | NULL    |       |#被锁的记录号</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| lock_data   | varchar(8192)       | YES  |     | NULL    |       |#被锁的数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">+————-+———————+——+—–+———+——-+</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">10 rows in set (0.00 sec)</span></span></code></pre></div><div class="language-markdown vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">markdown</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">&gt; desc innodb_lock_waits;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">+——————-+————-+——+—–+———+——-+</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| Field             | Type        | Null | Key | Default | Extra |</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">+——————-+————-+——+—–+———+——-+</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| requesting_trx_id | varchar(18) | NO   |     |         |       |#请求锁的事务ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| requested_lock_id | varchar(81) | NO   |     |         |       |#请求锁的锁ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| blocking_trx_id   | varchar(18) | NO   |     |         |       |#当前拥有锁的事务ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| blocking_lock_id  | varchar(81) | NO   |     |         |       |#当前拥有锁的锁ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">+——————-+————-+——+—–+———+——-+</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">4 rows in set (0.00 sec)</span></span></code></pre></div><div class="language-markdown vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">markdown</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#8DDB8C;">&gt; desc innodb_trx ;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">+—————————-+———————+——+—–+———————+——-+</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| Field                      | Type                | Null | Key | Default             | Extra |</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">+—————————-+———————+——+—–+———————+——-+</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_id                     | varchar(18)         | NO   |     |                     |       |#事务ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_state                  | varchar(13)         | NO   |     |                     |       |#事务状态：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_started                | datetime            | NO   |     | 0000-00-00 00:00:00 |       |#事务开始时间；</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_requested_lock_id      | varchar(81)         | YES  |     | NULL                |       |#innodb_locks.lock_id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_wait_started           | datetime            | YES  |     | NULL                |       |#事务开始等待的时间</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_weight                 | bigint(21) unsigned | NO   |     | 0                   |       |#</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_mysql_thread_id        | bigint(21) unsigned | NO   |     | 0                   |       |#事务线程ID</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_query                  | varchar(1024)       | YES  |     | NULL                |       |#具体SQL语句</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_operation_state        | varchar(64)         | YES  |     | NULL                |       |#事务当前操作状态</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_tables_in_use          | bigint(21) unsigned | NO   |     | 0                   |       |#事务中有多少个表被使用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_tables_locked          | bigint(21) unsigned | NO   |     | 0                   |       |#事务拥有多少个锁</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_lock_structs           | bigint(21) unsigned | NO   |     | 0                   |       |#</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_lock_memory_bytes      | bigint(21) unsigned | NO   |     | 0                   |       |#事务锁住的内存大小（B）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_rows_locked            | bigint(21) unsigned | NO   |     | 0                   |       |#事务锁住的行数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_rows_modified          | bigint(21) unsigned | NO   |     | 0                   |       |#事务更改的行数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_concurrency_tickets    | bigint(21) unsigned | NO   |     | 0                   |       |#事务并发票数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_isolation_level        | varchar(16)         | NO   |     |                     |       |#事务隔离级别</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_unique_checks          | int(1)              | NO   |     | 0                   |       |#是否唯一性检查</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_foreign_key_checks     | int(1)              | NO   |     | 0                   |       |#是否外键检查</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_last_foreign_key_error | varchar(256)        | YES  |     | NULL                |       |#最后的外键错误</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_adaptive_hash_latched  | int(1)              | NO   |     | 0                   |       |#</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">| trx_adaptive_hash_timeout  | bigint(21) unsigned | NO   |     | 0                   |       |#</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">+—————————-+———————+——+—–+———————+——-+</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">22 rows in set (0.01 sec)</span></span></code></pre></div><h2 id="锁的种类" tabindex="-1">锁的种类 <a class="header-anchor" href="#锁的种类" aria-label="Permalink to &quot;锁的种类&quot;">​</a></h2><p>Innodb存储引擎实现了如下2种标准的行级锁:</p><ul><li>共享锁(S lock)，允许事务读取一行数据。</li><li>排它锁(X lock)，允许事务删除或者更新一行数据。</li></ul><hr><div style="text-align:center;color:#00000099;font-size:14px;">END</div>`,15)]))}const g=i(t,[["render",p]]);export{o as __pageData,g as default};
