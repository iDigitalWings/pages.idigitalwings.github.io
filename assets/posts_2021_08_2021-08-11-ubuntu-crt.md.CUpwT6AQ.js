import{_ as i,a,af as t,o as l}from"./chunks/framework.C87LdZyP.js";const c=JSON.parse('{"title":"Ubuntu、Java 等软件添加 TLS/SSL 证书","description":"","frontmatter":{"title":"Ubuntu、Java 等软件添加 TLS/SSL 证书","date":"2021-08-12T00:00:00.000Z","tags":["运维"],"category":["运维"]},"headers":[],"relativePath":"posts/2021/08/2021-08-11-ubuntu-crt.md","filePath":"posts/2021/08/2021-08-11-ubuntu-crt.md","lastUpdated":1718187682000}'),n={name:"posts/2021/08/2021-08-11-ubuntu-crt.md"};function e(h,s,p,k,r,d){return l(),a("div",null,s[0]||(s[0]=[t(`<h2 id="ubuntu" tabindex="-1">Ubuntu <a class="header-anchor" href="#ubuntu" aria-label="Permalink to &quot;Ubuntu&quot;">​</a></h2><p>下载 aliyun 的证书 <code>xxx.cn_chain.crt</code>，</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cp</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> xxx.cn_chain.crt</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /usr/local/share/ca-certificates/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">update-ca-certificates</span></span></code></pre></div><h2 id="java" tabindex="-1">Java <a class="header-anchor" href="#java" aria-label="Permalink to &quot;Java&quot;">​</a></h2><h3 id="测试" tabindex="-1">测试 <a class="header-anchor" href="#测试" aria-label="Permalink to &quot;测试&quot;">​</a></h3><p><a href="./resources/2021-08-11-ubuntu-crt/SSLPoke.class">下载<code>SSLPoke.class</code></a></p><p>诊断连接是否可信：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$JAVA_HOME/bin/java SSLPoke example.com 443</span></span></code></pre></div><p>如果成功：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">$JAVA_HOME/bin/java SSLPoke example.com 443</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Successfully</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> connected</span></span></code></pre></div><p>失败：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">sun.security.validator.ValidatorException:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> PKIX</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> path</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> building</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> failed:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sun.security.provider.certpath.SunCertPathBuilderException:</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> unable</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> find</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> valid</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> certification</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> path</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> requested</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> target</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">	at</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sun.security.validator.PKIXValidator.doBuild</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">PKIXValidator.java:387</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">	at</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sun.security.validator.PKIXValidator.engineValidate</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">PKIXValidator.java:292</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">	at</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sun.security.validator.Validator.validate</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Validator.java:260</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">	at</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sun.security.ssl.X509TrustManagerImpl.validate</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">X509TrustManagerImpl.java:324</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">	at</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sun.security.ssl.X509TrustManagerImpl.checkTrusted</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">X509TrustManagerImpl.java:229</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">	at</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sun.security.ssl.X509TrustManagerImpl.checkServerTrusted</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">X509TrustManagerImpl.java:124</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span></code></pre></div><h3 id="证书" tabindex="-1">证书 <a class="header-anchor" href="#证书" aria-label="Permalink to &quot;证书&quot;">​</a></h3><p>Java 使用了一种叫 keystore 的文件来存储证书 (默认是位于 $JAVA_HOME/lib/security/cacerts ) 。</p><p>该文件使用 keytool 工具去管理 (该工具默认位于 $JAVA_HOME/bin/keytool )。</p><ol><li>备份<div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">cp</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $JAVA_HOME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/lib/security/cacerts</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $JAVA_HOME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/lib/security/cacerts.backup</span></span></code></pre></div></li><li>列出证书<div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 默认使用 ~/.keystore</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">keytool</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -list</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># 使用参数</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">keytool</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -list</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -keystore</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $JAVA_HOME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/lib/security/cacerts</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>keystore 文件都受 密码 保护。生成新的 keystore 文件时， 会要求你输入一个新密码；而当访问一个已有的 keystore 文件时， 会要求你验证密码。</p><p><code>$JAVA_HOME/lib/security/cacerts</code> 的默认密码为 <code>changeit</code></p><p>可以在命令后增加<code>-storepass changeit</code>设置密码参数</p></div></li><li>获取网站证书<div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># linux</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> s_client</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -connect</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> git.shuyi.com.cn:443</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /dev/null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> sed</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -ne</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> public.crt</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> s_client</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -connect</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ci.shuyi.com.cn:443</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /dev/null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> sed</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -ne</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &#39;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> public.crt</span></span></code></pre></div></li><li>导入证书<div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># jdk</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">keytool</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -import</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -alias</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> gitlab</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -keystore</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $JAVA_HOME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/jre/lib/security/cacerts</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -file</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> your.crt</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"># jre</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">keytool</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -import</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -alias</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> gitlab</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -keystore</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $JAVA_HOME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/lib/security/cacerts</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -file</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> your.crt</span></span></code></pre></div>比如：<div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">keytool</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -import</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -alias</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> mystore</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -keystore</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cacerts</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -file</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> public.crt</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -storepass</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> changeit</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">keytool</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -import</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -alias</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> shuyici</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -keystore</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> $JAVA_HOME</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/lib/security/cacerts</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -file</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> public.crt</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">  -storepass</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> changeit</span></span></code></pre></div></li></ol><h2 id="sonarqube-in-docker" tabindex="-1">SonarQube in Docker <a class="header-anchor" href="#sonarqube-in-docker" aria-label="Permalink to &quot;SonarQube in Docker&quot;">​</a></h2><p>SonarQube in Docker 可以使用标准 Java 的方式，也可以使用环境变量：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">SONARQUBE_WEB_JVM_OPTS:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -Djavax.net.ssl.trustStore=/tmp/sonarqube.jks</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -Djavax.net.ssl.trustStorePassword=changeit</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">SONARQUBE_WEB_JVM_OPTS:</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -Djavax.net.ssl.trustStore=/mymount/cacerts</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -Djavax.net.ssl.trustStorePassword=changeit</span></span></code></pre></div><p>或者自己构建一个镜像，比如如下 <code>multi-stage Dockerfile</code>：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">FROM</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> openjdk:8</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> AS</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> builder</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">COPY</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> cacert.pem</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /tmp/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">RUN</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> keytool</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -import</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -v</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -trustcacerts</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -alias</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> ipa</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -file</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> /tmp/cacert.pem</span><span style="--shiki-light:#005CC5;--shiki-dark:#F47067;"> \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">-keystore \${JAVA_HOME}</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/jre/lib/security/cacerts</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -noprompt</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -storepass</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> changeit</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">FROM</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> sonarqube:7.4-community</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">COPY</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> --from=builder</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> \${JAVA_HOME}</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/jre/lib/security/cacerts</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> \${JAVA_HOME}</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">/jre/lib/security/cacerts</span></span></code></pre></div><hr><ul><li><a href="https://ningyu1.github.io/site/post/53-ssl-cert-3/" target="_blank" rel="noreferrer">Java访问SSL地址，使用证书方式和免验证证书方式</a></li><li><a href="https://github.com/SonarSource/docker-sonarqube/issues/207" target="_blank" rel="noreferrer">Providing a truststore</a></li></ul>`,23)]))}const g=i(n,[["render",e]]);export{c as __pageData,g as default};
